<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¹´í…Œê³ ë¦¬</title>
  <link rel="stylesheet" href="../css/categorystyle.css" />
</head>
<body>
  <nav>
    <ul>
      <li><a href="../index.html">Home</a></li>
      <li><a href="category.html">Category</a></li>
      <li><a href="summary.html">summary</a></li>
      <li><a href="background.html">background</a></li>
      <li><a href="board.html">board</a></li>
    </ul>
  </nav>

  <header>
    <h1>ì´ë‹¬ì˜ ì¶”ì²œ ì±…</h1>
    <button id="toggle-form">ğŸ“š ì±… ë“±ë¡í•˜ê¸°</button>
  </header>

  <section id="category-buttons">
    <button class="cat-btn active" data-cat="all">ì „ì²´ë³´ê¸°</button>
    <button class="cat-btn" data-cat="ë¬¸í•™">ë¬¸í•™</button>
    <button class="cat-btn" data-cat="ê³¼í•™">ê³¼í•™</button>
    <button class="cat-btn" data-cat="ìê¸°ê³„ë°œ">ìê¸°ê³„ë°œ</button>
    <button class="cat-btn" data-cat="ì˜ˆìˆ ">ì˜ˆìˆ </button>
    <button class="cat-btn" data-cat="ê¸°íƒ€">ê¸°íƒ€</button>
  </section>

  <section id="form-section" style="display: none;">
    <form id="book-form">
      <select id="category" required>
        <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
        <option value="ë¬¸í•™">ë¬¸í•™</option>
        <option value="ê³¼í•™">ê³¼í•™</option>
        <option value="ìê¸°ê³„ë°œ">ìê¸°ê³„ë°œ</option>
        <option value="ì˜ˆìˆ ">ì˜ˆìˆ </option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>
      <input type="text" id="title" placeholder="ì±… ì œëª©" required />
      <input type="text" id="author" placeholder="ì‘ê°€" required />
      <input type="text" id="publisher" placeholder="ì¶œíŒì‚¬" required />
      <input type="text" id="buyLink" placeholder="êµ¬ë§¤ ë§í¬ (ì„ íƒ)" />
      <input type="file" id="cover" accept="image/*" />
      <button type="submit">ì±… ë“±ë¡</button>
    </form>
  </section>

  <section id="book-list"></section>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyD0aaH73fZlF_90cXLXJW9qjeRAsiy8hio",
      authDomain: "everybooks-25103.firebaseapp.com",
      databaseURL: "https://everybooks-25103-default-rtdb.asia-southeast1.firebasedatabase.app/", // Realtime DB URL ë°˜ë“œì‹œ ë„£ì–´ì•¼ í•¨
      projectId: "everybooks-25103",
      storageBucket: "everybooks-25103.appspot.com",
      messagingSenderId: "546607329490",
      appId: "1:546607329490:web:f2013f36118e9c0644bd0b"
    };

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const toggleBtn = document.getElementById('toggle-form');
    const formSection = document.getElementById('form-section');
    const bookForm = document.getElementById('book-form');
    const bookList = document.getElementById('book-list');
    const categoryButtons = document.querySelectorAll('.cat-btn');

    let currentFilter = 'all';

    // í¼ í† ê¸€
    toggleBtn.onclick = () => {
      formSection.style.display = formSection.style.display === 'none' ? 'block' : 'none';
    };

    // Firebaseì— ì±… ì €ì¥
    function saveBookToFirebase(book) {
      const booksRef = ref(database, 'books');
      const newBookRef = push(booksRef);
      return set(newBookRef, book);
    }

    // Firebaseì—ì„œ ì±… ë¶ˆëŸ¬ì˜¤ê¸° (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì•„ë‹˜, í•œë²ˆë§Œ)
    function loadBooksFromFirebase(callback) {
      const booksRef = ref(database, 'books');
      onValue(booksRef, (snapshot) => {
        const data = snapshot.val() || {};
        const booksArray = Object.keys(data).map(key => ({ id: key, ...data[key] }));
        callback(booksArray);
      });
    }

    // Firebaseì—ì„œ ì±… ì‚­ì œ
    function deleteBookFromFirebase(id) {
      const bookRef = ref(database, 'books/' + id);
      return remove(bookRef);
    }

    // ì±… ë Œë”ë§ í•¨ìˆ˜ (books ë°°ì—´ê³¼ í•„í„° ë°›ìŒ)
    function renderBooks(books, filter) {
      bookList.innerHTML = '';
      const filteredBooks = filter === 'all' ? books : books.filter(b => b.category === filter);

      if (filteredBooks.length === 0) {
        bookList.innerHTML = '<p>ë“±ë¡ëœ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      filteredBooks.forEach(book => {
        const card = document.createElement('div');
        card.className = 'book-card';
        card.innerHTML = `
          ${book.imageUrl ? `<img src="${book.imageUrl}" alt="ì±…í‘œì§€">` : ''}
          <div class="info">
            <h3>${book.title}</h3>
            <p>ğŸ‘¤ ${book.author}</p>
            <p>ğŸ¢ ${book.publisher}</p>
            ${book.buyLink ? `<p><a href="${book.buyLink}" target="_blank" rel="noopener noreferrer">ğŸ“– êµ¬ë§¤í•˜ê¸°</a></p>` : ''}
            <button class="delete-btn" data-id="${book.id}">ì‚­ì œ</button>
          </div>
        `;
        bookList.appendChild(card);
      });

      // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          if(confirm('ì •ë§ ì´ ì±…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            await deleteBookFromFirebase(id);
          }
        };
      });
    }

    // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸
    categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        categoryButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.getAttribute('data-cat');
        // ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° -> ë Œë”ë§ì€ onValue ë¦¬ìŠ¤ë„ˆê°€ ì²˜ë¦¬
        // ê·¸ë˜ì„œ ì—¬ê¸°ì„œëŠ” ë”°ë¡œ ë¶ˆëŸ¬ê¸° í•„ìš” ì—†ìŒ.
      });
    });

    // í¼ ì œì¶œ ì´ë²¤íŠ¸
    bookForm.onsubmit = (e) => {
      e.preventDefault();

      const category = document.getElementById('category').value;
      const title = document.getElementById('title').value;
      const author = document.getElementById('author').value;
      const publisher = document.getElementById('publisher').value;

      let buyLink = document.getElementById('buyLink').value.trim();
      if (buyLink && !buyLink.startsWith('http://') && !buyLink.startsWith('https://')) {
        buyLink = 'http://' + buyLink;
      }

      const coverInput = document.getElementById('cover');
      const book = { category, title, author, publisher, buyLink, imageUrl: '' };

      if (coverInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function () {
          book.imageUrl = reader.result;
          saveBookToFirebase(book);
          bookForm.reset();
          formSection.style.display = 'none';
        };
        reader.readAsDataURL(coverInput.files[0]);
      } else {
        saveBookToFirebase(book);
        bookForm.reset();
        formSection.style.display = 'none';
      }
    };

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ
    loadBooksFromFirebase((books) => {
      renderBooks(books, currentFilter);
    });

  </script>
</body>
</html>
